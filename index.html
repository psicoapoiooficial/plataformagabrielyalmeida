<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriStudy - Plataforma para Estudantes de Nutrição</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --secondary: #FF9800;
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #757575;
            --light-gray: #E0E0E0;
            --danger: #D32F2F;
            --success: #388E3C;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--secondary);
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            padding: 30px 0;
        }

        /* Sidebar */
        .sidebar {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }

        .sidebar h2 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .tools-list {
            list-style: none;
        }

        .tool-item {
            margin-bottom: 12px;
        }

        .tool-btn {
            width: 100%;
            padding: 15px;
            background-color: white;
            border: none;
            border-radius: 10px;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--light-gray);
        }

        .tool-btn:hover {
            background-color: #E8F5E9;
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background-color: #E8F5E9;
            color: var(--primary);
            border-left: 5px solid var(--primary);
            font-weight: 600;
        }

        .tool-btn i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 600px;
        }

        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F5F5F5;
        }

        .tool-header h2 {
            color: var(--primary-dark);
            font-size: 1.8rem;
        }

        .tool-header i {
            color: var(--primary);
            font-size: 2rem;
        }

        .tool-description {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tool Containers */
        .tool-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tool-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid Layouts for Tools */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        /* Card Styling */
        .card {
            background-color: #F9F9F9;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .card h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #F57C00;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #B71C1C;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        table th {
            background-color: #E8F5E9;
            color: var(--primary-dark);
            font-weight: 600;
        }

        table tr:hover {
            background-color: #F5F5F5;
        }

        /* Progress Bar */
        .progress-container {
            background-color: #E0E0E0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Footer */
        footer {
            background-color: var(--primary-dark);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-top: 40px;
        }

        footer p {
            margin-bottom: 10px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--secondary);
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        /* Utility Classes */
        .mt-3 { margin-top: 30px; }
        .mb-3 { margin-bottom: 30px; }
        .text-center { text-align: center; }
        .hidden { display: none; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background-color: #E8F5E9;
            color: var(--success);
            border-left: 5px solid var(--success);
        }
        .alert-info {
            background-color: #E3F2FD;
            color: #1976D2;
            border-left: 5px solid #1976D2;
        }

        /* Custom Components */
        .calculator-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .calculator-result {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            padding: 20px;
            background-color: #E8F5E9;
            border-radius: 10px;
            margin-top: 20px;
        }

        .flashcard {
            perspective: 1000px;
            height: 300px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .flashcard-front {
            background-color: white;
            color: var(--dark);
            border: 2px solid var(--primary);
        }

        .flashcard-back {
            background-color: var(--primary);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .meal-plan-day {
            border: 1px solid var(--light-gray);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .meal-plan-day h4 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .meal-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--light-gray);
        }

        .meal-item:last-child {
            border-bottom: none;
        }

        .countdown {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 20px 0;
        }

        /* Task List Styling */
        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .task-text {
            flex: 1;
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .task-text:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 1rem;
        }

        .task-btn:hover {
            color: var(--primary);
        }

        .completed {
            text-decoration: line-through;
            color: var(--gray);
        }

        /* Progress Chart */
        .progress-chart {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: flex-end;
            height: 200px;
        }

        .progress-day {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .progress-bar-day {
            width: 100%;
            background-color: var(--primary-light);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
        }

        .progress-label {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Anthropometric Measurements */
        .measurement-card {
            border: 1px solid var(--light-gray);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }

        .measurement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .measurement-values {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .measurement-value {
            display: flex;
            flex-direction: column;
        }

        .measurement-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .measurement-number {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary);
        }

        /* Delete button styling */
        .delete-btn {
            background-color: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .delete-btn:hover {
            color: #B71C1C;
        }

        /* Water goal settings */
        .water-goal-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Backup Quick Button */
        .backup-quick {
            margin-left: 20px;
        }

        .backup-quick .btn {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Custom Alerts */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Auto-save notification */
        .auto-save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
   <!-- Header -->
<header>
    <div class="container">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-apple-alt"></i>
                <h1><span></span> <small>Gabriely Almeida</small></h1>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="user-info">
                    <div>
                        <h3>Gabriely Almeida</h3>
                        <p>Estudante de Nutrição</p>
                    </div>
                    <img src="IMG-20260122-WA0078.jpg" alt="Gabriely Almeida">
                </div>
                <!-- BOTÃO DE BACKUP AQUI -->
                <div class="backup-quick">
                    <button class="btn btn-small" onclick="exportData()" title="Fazer backup rápido">
                        <i class="fas fa-cloud-download-alt"></i> Backup
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Main Dashboard -->
    <div class="container">
        <div class="dashboard">
            <!-- Sidebar with Tools List -->
            <aside class="sidebar">
                <h2>Ferramentas de Estudo</h2>
                <ul class="tools-list">
                    <li class="tool-item">
                        <button class="tool-btn active" data-tool="dashboard">
                            <i class="fas fa-home"></i> Dashboard
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="calculator">
                            <i class="fas fa-calculator"></i> Calculadora Nutricional
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="flashcards">
                            <i class="fas fa-layer-group"></i> Flashcards
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="meal-planner">
                            <i class="fas fa-utensils"></i> Planejador de Refeições
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="hydration">
                            <i class="fas fa-tint"></i> Controle de Hidratação
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="bmi">
                            <i class="fas fa-weight-scale"></i> Calculadora de IMC
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="macros">
                            <i class="fas fa-chart-pie"></i> Calculadora de Macronutrientes
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="anthropometric">
                            <i class="fas fa-ruler-combined"></i> Avaliação Antropométrica
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="notes">
                            <i class="fas fa-book"></i> Anotações de Aula
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="countdown">
                            <i class="fas fa-clock"></i> Contador de Estudos
                        </button>
                    </li>
                    <li class="tool-item">
                        <button class="tool-btn" data-tool="progress">
                            <i class="fas fa-chart-line"></i> Progresso de Estudos
                        </button>
                    </li>
                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Dashboard Tool -->
                <div id="dashboard" class="tool-container active">
                    <div class="tool-header">
                        <h2>Dashboard</h2>
                        <i class="fas fa-home"></i>
                    </div>
                    <p class="tool-description">Bem-vinda, Gabriely! Aqui você pode acessar todas as ferramentas para otimizar seus estudos e rotina como estudante de nutrição.</p>
                    
                    <div class="grid-3">
                        <div class="card">
                            <h3>Status de Hoje</h3>
                            <p><strong>Hidratação:</strong> <span id="hydration-status">0/2000ml</span></p>
                            <div class="progress-container">
                                <div id="hydration-progress" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <p><strong>Estudos Hoje:</strong> <span id="study-today">0 minutos</span></p>
                            <p><strong>Próxima Avaliação:</strong> <span id="next-exam">Fisiologia - 15 dias</span></p>
                        </div>
                        
                        <div class="card">
                            <h3>Ferramentas Mais Usadas</h3>
                            <ul style="list-style-type: none;">
                                <li><i class="fas fa-calculator"></i> Calculadora Nutricional</li>
                                <li><i class="fas fa-layer-group"></i> Flashcards</li>
                                <li><i class="fas fa-utensils"></i> Planejador de Refeições</li>
                            </ul>
                            <button class="btn mt-3" onclick="switchTool('flashcards')">
                                <i class="fas fa-play"></i> Continuar Estudando
                            </button>
                        </div>
                        
                        <div class="card">
                            <h3>Minhas Tarefas Hoje</h3>
                            <div id="task-list-container">
                                <ul class="task-list" id="task-list">
                                    <!-- Tasks will be loaded here -->
                                </ul>
                                <div class="form-group mt-3">
                                    <input type="text" id="new-task" class="form-control" placeholder="Adicionar nova tarefa...">
                                </div>
                                <button class="btn btn-small" onclick="addTask()">
                                    <i class="fas fa-plus"></i> Adicionar Tarefa
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup de Dados -->
                    <div class="card mt-3">
                        <h3>Backup de Dados</h3>
                        <p>Faça backup regularmente para não perder suas informações. Os dados são salvos apenas no seu navegador atual.</p>
                        
                        <div class="grid-3" style="margin-bottom: 15px;">
                            <button class="btn" onclick="exportData()">
                                <i class="fas fa-download"></i> Exportar Dados
                            </button>
                            <button class="btn btn-secondary" onclick="importData()">
                                <i class="fas fa-upload"></i> Importar Dados
                            </button>
                            <button class="btn btn-secondary" onclick="showBackupInfo()">
                                <i class="fas fa-info-circle"></i> Como Fazer Backup
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i> <strong>Recomendação:</strong> Exporte seus dados toda semana e salve o arquivo no Google Drive ou no seu computador.
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Dica do Dia</h3>
                        <p>Lembre-se de que a vitamina D é essencial para a absorção de cálcio e pode ser obtida não apenas através da alimentação, mas também pela exposição solar moderada. Para indivíduos com pele clara, 15 minutos diários ao sol são suficientes.</p>
                    </div>
                </div>

                <!-- Nutritional Calculator Tool -->
                <div id="calculator" class="tool-container">
                    <div class="tool-header">
                        <h2>Calculadora Nutricional</h2>
                        <i class="fas fa-calculator"></i>
                    </div>
                    <p class="tool-description">Calcule valores nutricionais de alimentos e refeições. Armazene cálculos frequentes para uso rápido.</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Calculadora de Calorias</h3>
                            <div class="form-group">
                                <label>Alimento/Refeição</label>
                                <input type="text" id="food-name" class="form-control" placeholder="Ex: Frango grelhado">
                            </div>
                            
                            <div class="calculator-row">
                                <div class="form-group" style="flex: 1;">
                                    <label>Proteínas (g)</label>
                                    <input type="number" id="protein" class="form-control" value="0" min="0">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Carboidratos (g)</label>
                                    <input type="number" id="carbs" class="form-control" value="0" min="0">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Gorduras (g)</label>
                                    <input type="number" id="fat" class="form-control" value="0" min="0">
                                </div>
                            </div>
                            
                            <button class="btn" onclick="calculateCalories()">
                                <i class="fas fa-calculator"></i> Calcular Calorias
                            </button>
                            
                            <div id="calories-result" class="calculator-result"></div>
                        </div>
                        
                        <div class="card">
                            <h3>Cálculos Salvos</h3>
                            <div id="saved-calculations">
                                <p class="alert alert-info">Nenhum cálculo salvo ainda. Realize um cálculo e salve-o aqui.</p>
                            </div>
                            <button class="btn btn-secondary mt-3" onclick="saveCalculation()">
                                <i class="fas fa-save"></i> Salvar Cálculo Atual
                            </button>
                            <button class="btn btn-danger btn-small mt-3" onclick="deleteAllCalculations()">
                                <i class="fas fa-trash"></i> Apagar Todos os Registros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Flashcards Tool -->
                <div id="flashcards" class="tool-container">
                    <div class="tool-header">
                        <h2>Flashcards de Nutrição</h2>
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <p class="tool-description">Estude conceitos importantes de nutrição com flashcards interativos. Adicione seus próprios cards personalizados.</p>
                    
                    <div class="flashcard" id="flashcard" onclick="toggleFlashcard()">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <h3 id="flashcard-question">O que são macronutrientes?</h3>
                                <p>Clique para ver a resposta</p>
                                <i class="fas fa-sync-alt" style="font-size: 2rem; margin-top: 20px; color: var(--primary);"></i>
                            </div>
                            <div class="flashcard-back">
                                <h3>Resposta:</h3>
                                <p id="flashcard-answer">São nutrientes necessários em grandes quantidades pelo organismo, que fornecem energia: carboidratos, proteínas e lipídios.</p>
                                <i class="fas fa-sync-alt" style="font-size: 2rem; margin-top: 20px; color: white;"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flashcard-nav">
                        <button class="btn btn-secondary" onclick="prevFlashcard()">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <span id="flashcard-counter">1/5</span>
                        <button class="btn btn-secondary" onclick="nextFlashcard()">
                            Próximo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Criar Novo Flashcard</h3>
                        <div class="form-group">
                            <label>Pergunta/Conceito</label>
                            <input type="text" id="new-question" class="form-control" placeholder="Ex: O que é termogênese?">
                        </div>
                        <div class="form-group">
                            <label>Resposta/Definição</label>
                            <textarea id="new-answer" class="form-control" placeholder="Ex: Processo de produção de calor pelo organismo..."></textarea>
                        </div>
                        <button class="btn" onclick="addFlashcard()">
                            <i class="fas fa-plus"></i> Adicionar Flashcard
                        </button>
                        <button class="btn btn-danger btn-small mt-3" onclick="deleteCurrentFlashcard()">
                            <i class="fas fa-trash"></i> Apagar Flashcard Atual
                        </button>
                    </div>
                </div>

                <!-- Meal Planner Tool -->
                <div id="meal-planner" class="tool-container">
                    <div class="tool-header">
                        <h2>Planejador de Refeições</h2>
                        <i class="fas fa-utensils"></i>
                    </div>
                    <p class="tool-description">Planeje suas refeições da semana com equilíbrio nutricional. Acompanhe macronutrientes e calorias totais.</p>
                    
                    <div class="card mb-3">
                        <h3>Planejamento Semanal</h3>
                        <select id="week-day" class="form-control" onchange="loadMealPlan()">
                            <option value="segunda">Segunda-feira</option>
                            <option value="terca">Terça-feira</option>
                            <option value="quarta">Quarta-feira</option>
                            <option value="quinta">Quinta-feira</option>
                            <option value="sexta">Sexta-feira</option>
                            <option value="sabado">Sábado</option>
                            <option value="domingo">Domingo</option>
                        </select>
                    </div>
                    
                    <div id="meal-plan-content">
                        <!-- Meal plan will be loaded here -->
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Adicionar Nova Refeição</h3>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Refeição</label>
                                <select id="meal-type" class="form-control">
                                    <option value="cafe">Café da Manhã</option>
                                    <option value="lanche1">Lanche da Manhã</option>
                                    <option value="almoco">Almoço</option>
                                    <option value="lanche2">Lanche da Tarde</option>
                                    <option value="jantar">Jantar</option>
                                    <option value="ceia">Ceia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" id="meal-description" class="form-control" placeholder="Ex: Omelete com 2 ovos e espinafre">
                            </div>
                            <div class="form-group">
                                <label>Calorias (kcal)</label>
                                <input type="number" id="meal-calories" class="form-control" placeholder="Ex: 350">
                            </div>
                        </div>
                        <button class="btn" onclick="addMeal()">
                            <i class="fas fa-plus"></i> Adicionar Refeição
                        </button>
                        <button class="btn btn-danger btn-small mt-3" onclick="deleteAllMealsForDay()">
                            <i class="fas fa-trash"></i> Apagar Todas as Refeições do Dia
                        </button>
                    </div>
                </div>

                <!-- Hydration Tracker Tool -->
                <div id="hydration" class="tool-container">
                    <div class="tool-header">
                        <h2>Controle de Hidratação</h2>
                        <i class="fas fa-tint"></i>
                    </div>
                    <p class="tool-description">Acompanhe sua ingestão diária de água. Lembretes personalizáveis ajudam a manter a hidratação adequada.</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Controle Diário</h3>
                            <div class="text-center">
                                <div class="countdown" style="font-size: 4rem; color: var(--primary);" id="water-amount">0ml</div>
                                <p>de <span id="water-goal-display">2000</span>ml recomendados</p>
                            </div>
                            
                            <div class="progress-container mt-3">
                                <div id="water-progress" class="progress-bar" style="width: 0%"></div>
                            </div>
                            
                            <div class="grid-3 mt-3">
                                <button class="btn" onclick="addWater(200)">
                                    <i class="fas fa-plus"></i> +200ml
                                </button>
                                <button class="btn" onclick="addWater(500)">
                                    <i class="fas fa-plus"></i> +500ml
                                </button>
                                <button class="btn" onclick="addWater(1000)">
                                    <i class="fas fa-plus"></i> +1L
                                </button>
                            </div>
                            
                            <button class="btn btn-secondary mt-3" onclick="resetWater()" style="width: 100%;">
                                <i class="fas fa-redo"></i> Reiniciar para Hoje
                            </button>
                            
                            <div class="water-goal-setting mt-3">
                                <input type="number" id="water-goal-input" class="form-control" placeholder="Meta em ml" value="2000">
                                <button class="btn btn-small" onclick="updateWaterGoal()">
                                    <i class="fas fa-save"></i> Alterar Meta
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>Histórico de Hidratação</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Consumo (ml)</th>
                                        <th>Meta Atingida</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="hydration-history">
                                    <!-- History will be loaded here -->
                                </tbody>
                            </table>
                            <button class="btn btn-danger btn-small mt-3" onclick="deleteAllHydrationHistory()">
                                <i class="fas fa-trash"></i> Apagar Todo Histórico
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Lembretes de Hidratação</h3>
                        <div class="form-group">
                            <label>Intervalo de Lembretes (minutos)</label>
                            <select id="reminder-interval" class="form-control">
                                <option value="30">30 minutos</option>
                                <option value="60" selected>60 minutos</option>
                                <option value="90">90 minutos</option>
                                <option value="120">120 minutos</option>
                            </select>
                        </div>
                        <button class="btn" onclick="setHydrationReminder()">
                            <i class="fas fa-bell"></i> Ativar Lembretes
                        </button>
                        <p class="mt-3"><small>Os lembretes serão exibidos como notificações no navegador.</small></p>
                    </div>
                </div>

                <!-- BMI Calculator Tool -->
                <div id="bmi" class="tool-container">
                    <div class="tool-header">
                        <h2>Calculadora de IMC</h2>
                        <i class="fas fa-weight-scale"></i>
                    </div>
                    <p class="tool-description">Calcule seu Índice de Massa Corporal e veja a classificação de acordo com a OMS.</p>
                    <div class="card">
                        <div class="grid-2">
                            <div>
                                <div class="form-group">
                                    <label>Peso (kg)</label>
                                    <input type="number" id="weight" class="form-control" placeholder="Ex: 65">
                                </div>
                                <div class="form-group">
                                    <label>Altura (cm)</label>
                                    <input type="number" id="height" class="form-control" placeholder="Ex: 170">
                                </div>
                                <button class="btn" onclick="calculateBMI()">
                                    <i class="fas fa-calculator"></i> Calcular IMC
                                </button>
                            </div>
                            <div>
                                <div id="bmi-result" class="calculator-result" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                                    Resultado aparecerá aqui
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small mt-3" onclick="deleteAllBMIHistory()">
                            <i class="fas fa-trash"></i> Apagar Histórico de IMC
                        </button>
                    </div>
                </div>

                <!-- Macronutrients Calculator Tool -->
                <div id="macros" class="tool-container">
                    <div class="tool-header">
                        <h2>Calculadora de Macronutrientes</h2>
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <p class="tool-description">Calcule a distribuição ideal de macronutrientes com base em seus objetivos (manutenção, perda ou ganho de peso).</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Cálculo de Macronutrientes</h3>
                            <div class="form-group">
                                <label>Calorias Diárias (kcal)</label>
                                <input type="number" id="daily-calories" class="form-control" placeholder="Ex: 2000" value="2000">
                            </div>
                            
                            <div class="form-group">
                                <label>Objetivo</label>
                                <select id="goal" class="form-control">
                                    <option value="maintenance">Manutenção de Peso</option>
                                    <option value="loss">Perda de Peso</option>
                                    <option value="gain">Ganho de Massa Muscular</option>
                                </select>
                            </div>
                            
                            <button class="btn" onclick="calculateMacros()">
                                <i class="fas fa-calculator"></i> Calcular Macronutrientes
                            </button>
                            
                            <div id="macros-result" class="calculator-result mt-3" style="display: none;">
                                <h4>Distribuição Recomendada</h4>
                                <div id="macros-details"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>Distribuição de Macronutrientes</h3>
                            <div style="text-align: center;">
                                <canvas id="macros-chart" width="300" height="300"></canvas>
                            </div>
                            <div id="macros-explanation" class="mt-3">
                                <p><strong>Proteínas:</strong> 4 kcal/g - Essenciais para construção e reparo muscular</p>
                                <p><strong>Carboidratos:</strong> 4 kcal/g - Principal fonte de energia para o corpo</p>
                                <p><strong>Gorduras:</strong> 9 kcal/g - Importantes para hormônios e absorção de vitaminas</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Anthropometric Assessment Tool -->
                <div id="anthropometric" class="tool-container">
                    <div class="tool-header">
                        <h2>Avaliação Antropométrica</h2>
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <p class="tool-description">Registre e acompanhe medidas antropométricas para avaliação nutricional completa. Calcule circunferências, dobras cutâneas e mais.</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Nova Avaliação</h3>
                            <div class="form-group">
                                <label>Nome do Paciente/Cliente</label>
                                <input type="text" id="patient-name" class="form-control" placeholder="Ex: João Silva">
                            </div>
                            
                            <div class="form-group">
                                <label>Data da Avaliação</label>
                                <input type="date" id="assessment-date" class="form-control" value="">
                            </div>
                            
                            <div class="grid-3">
                                <div class="form-group">
                                    <label>Peso (kg)</label>
                                    <input type="number" id="anthro-weight" class="form-control" placeholder="Ex: 70.5" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Altura (cm)</label>
                                    <input type="number" id="anthro-height" class="form-control" placeholder="Ex: 175">
                                </div>
                                <div class="form-group">
                                    <label>Idade</label>
                                    <input type="number" id="anthro-age" class="form-control" placeholder="Ex: 25">
                                </div>
                            </div>
                            
                            <h4 class="mt-3">Circunferências (cm)</h4>
                            <div class="grid-3">
                                <div class="form-group">
                                    <label>Cintura</label>
                                    <input type="number" id="waist-circ" class="form-control" placeholder="Ex: 85" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Quadril</label>
                                    <input type="number" id="hip-circ" class="form-control" placeholder="Ex: 95" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Braço</label>
                                    <input type="number" id="arm-circ" class="form-control" placeholder="Ex: 30" step="0.1">
                                </div>
                            </div>
                            
                            <h4 class="mt-3">Dobras Cutâneas (mm)</h4>
                            <div class="grid-3">
                                <div class="form-group">
                                    <label>Tríceps</label>
                                    <input type="number" id="triceps-sf" class="form-control" placeholder="Ex: 15" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Subescapular</label>
                                    <input type="number" id="subscapular-sf" class="form-control" placeholder="Ex: 20" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Abdômen</label>
                                    <input type="number" id="abdominal-sf" class="form-control" placeholder="Ex: 25" step="0.1">
                                </div>
                            </div>
                            
                            <button class="btn mt-3" onclick="calculateAnthropometric()">
                                <i class="fas fa-calculator"></i> Calcular Avaliação
                            </button>
                        </div>
                        
                        <div class="card">
                            <h3>Resultados da Avaliação</h3>
                            <div id="anthro-results" class="calculator-result" style="display: none; text-align: left;">
                                <!-- Results will be displayed here -->
                            </div>
                            
                            <div class="mt-3">
                                <h4>Histórico de Avaliações</h4>
                                <div id="anthro-history">
                                    <!-- History will be loaded here -->
                                </div>
                                <button class="btn btn-danger btn-small mt-3" onclick="deleteAllAnthropometricHistory()">
                                    <i class="fas fa-trash"></i> Apagar Todo Histórico
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Interpretação dos Resultados</h3>
                        <div class="grid-3">
                            <div>
                                <h4>Relação Cintura/Quadril</h4>
                                <ul>
                                    <li><strong>Homens:</strong> ≤ 0.90 (normal)</li>
                                    <li><strong>Mulheres:</strong> ≤ 0.85 (normal)</li>
                                    <li>Acima: risco cardiovascular</li>
                                </ul>
                            </div>
                            <div>
                                <h4>IMC (kg/m²)</h4>
                                <ul>
                                    <li>< 18.5: Baixo peso</li>
                                    <li>18.5-24.9: Normal</li>
                                    <li>25.0-29.9: Sobrepeso</li>
                                    <li>≥ 30.0: Obesidade</li>
                                </ul>
                            </div>
                            <div>
                                <h4>% Gordura Corporal</h4>
                                <ul>
                                    <li><strong>Mulheres:</strong> 25-31% (normal)</li>
                                    <li><strong>Homens:</strong> 18-24% (normal)</li>
                                    <li>Acima: excesso de gordura</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Notes Tool -->
                <div id="notes" class="tool-container">
                    <div class="tool-header">
                        <h2>Anotações de Aula</h2>
                        <i class="fas fa-book"></i>
                    </div>
                    <p class="tool-description">Organize suas anotações por disciplina. Adicione, edite e pesquise em suas notas de forma eficiente.</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Adicionar Nova Anotação</h3>
                            <div class="form-group">
                                <label>Disciplina</label>
                                <select id="note-subject" class="form-control">
                                    <option value="bioquimica">Bioquímica</option>
                                    <option value="fisiologia">Fisiologia</option>
                                    <option value="dietetica">Dietética</option>
                                    <option value="nutricaohumana">Nutrição Humana</option>
                                    <option value="bromatologia">Bromatologia</option>
                                    <option value="outro">Outra</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Título da Anotação</label>
                                <input type="text" id="note-title" class="form-control" placeholder="Ex: Metabolismo dos lipídios">
                            </div>
                            
                            <div class="form-group">
                                <label>Conteúdo</label>
                                <textarea id="note-content" class="form-control" rows="8" placeholder="Digite suas anotações aqui..."></textarea>
                            </div>
                            
                            <button class="btn" onclick="addNote()">
                                <i class="fas fa-save"></i> Salvar Anotação
                            </button>
                        </div>
                        
                        <div class="card">
                            <h3>Minhas Anotações</h3>
                            <div class="form-group">
                                <input type="text" id="note-search" class="form-control" placeholder="Pesquisar anotações..." onkeyup="searchNotes()">
                            </div>
                            
                            <div id="notes-list" style="max-height: 400px; overflow-y: auto;">
                                <!-- Notes will be loaded here -->
                            </div>
                            <button class="btn btn-danger btn-small mt-3" onclick="deleteAllNotes()">
                                <i class="fas fa-trash"></i> Apagar Todas as Anotações
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Study Countdown Tool -->
                <div id="countdown" class="tool-container">
                    <div class="tool-header">
                        <h2>Contador de Estudos Pomodoro</h2>
                        <i class="fas fa-clock"></i>
                    </div>
                    <p class="tool-description">Use a técnica Pomodoro para otimizar seus estudos: 25 minutos de foco seguidos de 5 minutos de pausa.</p>
                    <div class="card text-center">
                        <div class="countdown" id="timer">25:00</div>
                        <div style="margin: 20px 0;">
                            <span id="timer-status" style="font-weight: bold; color: var(--primary);">Pronto para começar</span>
                        </div>
                        <div class="grid-4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <button class="btn" onclick="startStudyTimer()">
                                <i class="fas fa-play"></i> Estudo (25min)
                            </button>
                            <button class="btn btn-secondary" onclick="startBreakTimer()">
                                <i class="fas fa-coffee"></i> Pausa (5min)
                            </button>
                            <button class="btn" onclick="pauseTimer()">
                                <i class="fas fa-pause"></i> Pausar
                            </button>
                            <button class="btn" onclick="resetTimer()">
                                <i class="fas fa-redo"></i> Reiniciar
                            </button>
                        </div>
                        <div class="mt-3">
                            <h4>Sessões Completas Hoje: <span id="sessions-count">0</span></h4>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Histórico de Sessões</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Sessões</th>
                                    <th>Tempo Total</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-history">
                                <!-- History will be loaded here -->
                            </tbody>
                        </table>
                        <button class="btn btn-danger btn-small mt-3" onclick="deleteAllSessionsHistory()">
                            <i class="fas fa-trash"></i> Apagar Todo Histórico
                        </button>
                    </div>
                </div>

                <!-- Progress Tracker Tool -->
                <div id="progress" class="tool-container">
                    <div class="tool-header">
                        <h2>Progresso de Estudos</h2>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <p class="tool-description">Acompanhe seu progresso nas disciplinas e visualize seu desempenho ao longo do tempo.</p>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>Progresso Semanal</h3>
                            <div id="progress-chart" class="progress-chart">
                                <!-- Progress bars will be generated here -->
                            </div>
                            <div class="text-center mt-3">
                                <p><strong>Tempo total de estudo esta semana:</strong> <span id="weekly-total">0</span> minutos</p>
                                <button class="btn btn-small mt-3" onclick="resetWeeklyProgress()">
                                    <i class="fas fa-redo"></i> Reiniciar Semana
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>Disciplinas</h3>
                            <div id="subjects-progress">
                                <!-- Subjects progress will be loaded here -->
                            </div>
                            <div class="form-group mt-3">
                                <input type="text" id="new-subject" class="form-control" placeholder="Adicionar nova disciplina...">
                            </div>
                            <button class="btn btn-small" onclick="addNewSubject()">
                                <i class="fas fa-plus"></i> Adicionar Disciplina
                            </button>
                            <div class="form-group mt-3">
                                <input type="number" id="subject-time" class="form-control" placeholder="Minutos estudados">
                            </div>
                            <div class="form-group">
                                <select id="subject-select" class="form-control">
                                    <!-- Subjects will be loaded here -->
                                </select>
                            </div>
                            <button class="btn btn-small" onclick="addTimeToSubject()">
                                <i class="fas fa-plus"></i> Adicionar Tempo
                            </button>
                            <button class="btn btn-danger btn-small mt-3" onclick="deleteAllSubjects()">
                                <i class="fas fa-trash"></i> Apagar Todas as Disciplinas
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <h3>Metas de Estudo</h3>
                        <div class="grid-3">
                            <div>
                                <h4>Meta Diária</h4>
                                <div class="progress-container">
                                    <div id="daily-goal-progress" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <p><span id="daily-goal-text">0/120 minutos</span></p>
                                <div class="water-goal-setting mt-2">
                                    <input type="number" id="daily-goal-input" class="form-control" placeholder="Meta em minutos" value="120" style="width: 120px;">
                                    <button class="btn btn-small" onclick="updateDailyGoal()">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h4>Meta Semanal</h4>
                                <div class="progress-container">
                                    <div id="weekly-goal-progress" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <p><span id="weekly-goal-text">0/840 minutos</span></p>
                                <div class="water-goal-setting mt-2">
                                    <input type="number" id="weekly-goal-input" class="form-control" placeholder="Meta em minutos" value="840" style="width: 120px;">
                                    <button class="btn btn-small" onclick="updateWeeklyGoal()">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h4>Avaliações</h4>
                                <p>Próxima: <strong>Fisiologia</strong></p>
                                <p>Dias restantes: <strong id="days-to-exam">15</strong></p>
                                <button class="btn btn-small mt-2" onclick="resetStudyProgress()">
                                    <i class="fas fa-redo"></i> Reiniciar Progresso
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>NutriStudy - Plataforma de Estudos para Nutrição</p>
            <p>Desenvolvida para Gabriely Almeida &copy; 2026</p>
            <div class="footer-links">
                <a href="#"><i class="fab fa-instagram"></i> Instagram</a>
                <a href="#"><i class="fas fa-envelope"></i> Contato</a>
                <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a>
            </div>
        </div>
    </footer>

    <script>
    // ============================================
    // CORREÇÃO CRÍTICA: SISTEMA DE PERSISTÊNCIA MELHORADO
    // ============================================

    // Versão dos dados - MUDE SEMPRE QUE ATUALIZAR A ESTRUTURA
    const DATA_VERSION = '2.0.0';
    const STORAGE_KEY = 'nutristudy_gabriely_data_v2';

    // Global data storage
    let userData = {
        // METADADOS IMPORTANTES
        _version: DATA_VERSION,
        _lastSave: new Date().toISOString(),
        
        // SEUS DADOS
        hydration: {
            current: 0,
            goal: 2000,
            history: []
        },
        flashcards: [
            { question: "O que são macronutrientes?", answer: "São nutrientes necessários em grandes quantidades pelo organismo, que fornecem energia: carboidratos, proteínas e lipídios." },
            { question: "Qual a função principal das vitaminas?", answer: "Atuar como cofatores enzimáticos, antioxidantes e reguladores de processos fisiológicos, sem fornecer energia diretamente." },
            { question: "O que é a digestão?", answer: "Processo de transformação dos alimentos em moléculas pequenas e absorvíveis, ocorrendo por meio de processos mecânicos e químicos." },
            { question: "Cite 3 alimentos ricos em ferro", answer: "Carnes vermelhas, fígado, feijão, espinafre e beterraba." },
            { question: "O que são probióticos?", answer: "Microrganismos vivos que, quando administrados em quantidades adequadas, conferem benefícios à saúde do hospedeiro." }
        ],
        mealPlans: {},
        calculations: [],
        bmiHistory: [],
        studySessions: 0,
        notes: [],
        tasks: [
            { id: 1, text: "Revisar bioquímica metabólica", completed: false },
            { id: 2, text: "Preparar flashcards vitaminas", completed: false },
            { id: 3, text: "Calcular dieta para caso clínico", completed: false },
            { id: 4, text: "Beber 500ml de água", completed: false }
        ],
        studyProgress: {
            daily: 0,
            weekly: [0, 0, 0, 0, 0, 0, 0], // Segunda a Domingo
            subjects: [
                { name: "Bioquímica", time: 120, goal: 300 },
                { name: "Fisiologia", time: 90, goal: 240 },
                { name: "Dietética", time: 60, goal: 180 }
            ],
            dailyGoal: 120,
            weeklyGoal: 840
        },
        sessionsHistory: [],
        anthropometricAssessments: []
    };

    // ============================================
    // SISTEMA DE SALVAR/CARREGAR - CORRIGIDO
    // ============================================

    // Salvar dados com MÚLTIPLOS backups
    function saveData() {
        try {
            // Atualiza metadados
            userData._lastSave = new Date().toISOString();
            userData._version = DATA_VERSION;
            
            // 1. SALVA NO LOCALSTORAGE (principal)
            const dataStr = JSON.stringify(userData);
            localStorage.setItem(STORAGE_KEY, dataStr);
            
            // 2. SALVA BACKUP NO SESSIONSTORAGE (redundância)
            try {
                sessionStorage.setItem('nutristudy_backup', dataStr);
            } catch (e) {
                console.log('SessionStorage cheio, ignorando backup...');
            }
            
            // 3. SALVA EM OUTRA CHAVE TAMBÉM (extra backup)
            localStorage.setItem('nutristudy_backup_' + new Date().getDate(), dataStr);
            
            // 4. Mantém compatibilidade com versão antiga
            localStorage.setItem('nutristudy_gabriely', dataStr);
            
            console.log('✅ Dados salvos com sucesso!', new Date().toLocaleTimeString());
            
            // Mostra notificação visual (opcional)
            showAutoSaveNotification();
            
            return true;
            
        } catch (error) {
            console.error('❌ ERRO ao salvar dados:', error);
            
            // Tenta salvar de forma simplificada
            try {
                const simpleData = {
                    hydration: userData.hydration,
                    tasks: userData.tasks,
                    notes: userData.notes,
                    flashcards: userData.flashcards
                };
                localStorage.setItem('nutristudy_emergency', JSON.stringify(simpleData));
                console.log('✅ Dados essenciais salvos em backup de emergência');
            } catch (e2) {
                console.error('❌ Falha até no backup de emergência');
            }
            
            return false;
        }
    }

    // Carregar dados de TODAS as fontes possíveis
    function loadData() {
        try {
            console.log('🔍 Buscando dados salvos...');
            
            // Lista de possíveis locais onde os dados podem estar
            const possibleKeys = [
                STORAGE_KEY,                    // Chave principal atual
                'nutristudy_gabriely',          // Chave antiga
                'nutristudy_backup',            // Backup no sessionStorage
                'nutristudy_emergency'          // Backup de emergência
            ];
            
            // Adiciona backups diários
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                possibleKeys.push('nutristudy_backup_' + date.getDate());
            }
            
            let loadedData = null;
            
            // Tenta cada uma das chaves
            for (const key of possibleKeys) {
                const stored = localStorage.getItem(key) || sessionStorage.getItem(key);
                
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        
                        // Verifica se tem dados válidos
                        if (parsed && typeof parsed === 'object') {
                            console.log('📂 Dados encontrados em:', key);
                            loadedData = parsed;
                            break;
                        }
                    } catch (e) {
                        console.log('⚠️ Dados inválidos em', key);
                    }
                }
            }
            
            if (loadedData) {
                // VERIFICA VERSÃO
                if (loadedData._version !== DATA_VERSION) {
                    console.log('⚠️ Versão diferente:', loadedData._version, '->', DATA_VERSION);
                    
                    // Migração de versão
                    if (confirm('Dados de versão anterior encontrados. Deseja migrar para a nova versão?')) {
                        loadedData = migrateData(loadedData);
                    }
                }
                
                // MERGE dos dados (preserva novos campos)
                userData = deepMerge(userData, loadedData);
                
                // GARANTE que arrays existam
                ensureDataStructure();
                
                console.log('✅ Dados carregados com sucesso!');
                console.log('📊 Estatísticas:', {
                    notas: userData.notes?.length || 0,
                    flashcards: userData.flashcards?.length || 0,
                    tarefas: userData.tasks?.length || 0
                });
                
            } else {
                console.log('ℹ️ Nenhum dado salvo encontrado, usando padrão');
            }
            
            // Atualiza a interface
            updateAllDisplays();
            
            return true;
            
        } catch (error) {
            console.error('❌ ERRO crítico ao carregar dados:', error);
            alert('⚠️ Erro ao carregar dados anteriores. Usando configuração padrão.');
            return false;
        }
    }

    // Função para garantir estrutura dos dados
    function ensureDataStructure() {
        // Garante que objetos existam
        userData.hydration = userData.hydration || { current: 0, goal: 2000, history: [] };
        userData.flashcards = userData.flashcards || [];
        userData.mealPlans = userData.mealPlans || {};
        userData.calculations = userData.calculations || [];
        userData.bmiHistory = userData.bmiHistory || [];
        userData.notes = userData.notes || [];
        userData.tasks = userData.tasks || [];
        userData.studyProgress = userData.studyProgress || {
            daily: 0,
            weekly: [0, 0, 0, 0, 0, 0, 0],
            subjects: [],
            dailyGoal: 120,
            weeklyGoal: 840
        };
        userData.sessionsHistory = userData.sessionsHistory || [];
        userData.anthropometricAssessments = userData.anthropometricAssessments || [];
        
        // Garante arrays
        if (!Array.isArray(userData.studyProgress.weekly)) {
            userData.studyProgress.weekly = [0, 0, 0, 0, 0, 0, 0];
        }
        if (!Array.isArray(userData.studyProgress.subjects)) {
            userData.studyProgress.subjects = [];
        }
    }

    // Merge profundo de objetos
    function deepMerge(target, source) {
        const output = { ...target };
        
        if (isObject(target) && isObject(source)) {
            Object.keys(source).forEach(key => {
                if (isObject(source[key])) {
                    if (!(key in target)) {
                        output[key] = source[key];
                    } else {
                        output[key] = deepMerge(target[key], source[key]);
                    }
                } else {
                    output[key] = source[key];
                }
            });
        }
        
        return output;
    }

    function isObject(item) {
        return item && typeof item === 'object' && !Array.isArray(item);
    }

    // Migração de dados entre versões
    function migrateData(oldData) {
        console.log('🔄 Migrando dados...');
        
        // Preserva dados importantes
        const migrated = {
            _version: DATA_VERSION,
            _lastSave: new Date().toISOString(),
            hydration: oldData.hydration || userData.hydration,
            flashcards: oldData.flashcards || userData.flashcards,
            mealPlans: oldData.mealPlans || userData.mealPlans,
            calculations: oldData.calculations || userData.calculations,
            bmiHistory: oldData.bmiHistory || userData.bmiHistory,
            studySessions: oldData.studySessions || userData.studySessions,
            notes: oldData.notes || userData.notes,
            tasks: oldData.tasks || userData.tasks,
            studyProgress: oldData.studyProgress || userData.studyProgress,
            sessionsHistory: oldData.sessionsHistory || userData.sessionsHistory,
            anthropometricAssessments: oldData.anthropometricAssessments || userData.anthropometricAssessments
        };
        
        return migrated;
    }

    // ============================================
    // NOTIFICAÇÕES DE SALVAMENTO
    // ============================================

    function showAutoSaveNotification() {
        // Remove notificação anterior
        const existing = document.querySelector('.auto-save-notification');
        if (existing) existing.remove();
        
        // Cria nova notificação
        const notification = document.createElement('div');
        notification.className = 'auto-save-notification';
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i> Dados salvos
            <span class="time">${new Date().toLocaleTimeString().slice(0,5)}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Remove após 3 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
    }

    // ============================================
    // BACKUP E EXPORTAÇÃO
    // ============================================

    function exportData() {
        try {
            // Garante dados atualizados
            saveData();
            
            // Prepara dados para exportação
            const exportData = {
                ...userData,
                _exportDate: new Date().toISOString(),
                _exportApp: 'NutriStudy',
                _exportVersion: DATA_VERSION
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Cria link de download
            const a = document.createElement('a');
            a.href = url;
            a.download = `nutristudy_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(a);
            a.click();
            
            // Limpeza
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            // Mostra mensagem
            alert(`✅ Backup exportado com sucesso!\n\nSalve o arquivo em:\n• Google Drive\n• Seu computador\n• E-mail\n\nPara restaurar: Use "Importar Dados"`);
            
        } catch (error) {
            console.error('Erro ao exportar:', error);
            alert('❌ Erro ao exportar backup. Tente novamente.');
        }
    }

    function importData() {
        if (!confirm('⚠️ ATENÇÃO: Isso substituirá todos os dados atuais.\n\nTem certeza que deseja continuar?')) {
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validação básica
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('Arquivo inválido');
                    }
                    
                    // Remove metadados de exportação
                    delete importedData._exportDate;
                    delete importedData._exportApp;
                    delete importedData._exportVersion;
                    
                    // Atualiza os dados
                    userData = deepMerge(userData, importedData);
                    saveData();
                    
                    alert('✅ Dados importados com sucesso!\n\nA página será recarregada.');
                    
                    // Recarrega a página
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    alert('❌ Erro ao importar dados. Verifique se o arquivo é válido.');
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }

    function showBackupInfo() {
        const lastBackup = userData._lastSave ? 
            new Date(userData._lastSave).toLocaleString('pt-BR') : 
            'Nunca';
        
        const infoHtml = `
            <h4>Como fazer backup corretamente</h4>
            <ol style="text-align: left; margin-left: 20px;">
                <li>Clique em <strong>"Exportar Dados"</strong></li>
                <li>Salve o arquivo <code>.json</code> no seu computador</li>
                <li>Faça uma cópia no Google Drive, OneDrive ou outro serviço de nuvem</li>
                <li>Repita esse processo toda semana</li>
            </ol>
            
            <h4>Estatísticas Atuais</h4>
            <ul style="text-align: left; margin-left: 20px;">
                <li><strong>Último backup:</strong> ${lastBackup}</li>
                <li><strong>Anotações salvas:</strong> ${userData.notes?.length || 0}</li>
                <li><strong>Flashcards:</strong> ${userData.flashcards?.length || 0}</li>
                <li><strong>Cálculos salvos:</strong> ${userData.calculations?.length || 0}</li>
            </ul>
            
            <h4>Dicas</h4>
            <ul style="text-align: left; margin-left: 20px;">
                <li>Mantenha pelo menos 2 backups em locais diferentes</li>
                <li>Após formatar o computador, use "Importar Dados"</li>
                <li>Teste seu backup ocasionalmente importando em modo anônimo</li>
            </ul>
        `;
        
        // Criar modal simples
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--primary);">Informações de Backup</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            ${infoHtml}
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn" onclick="exportData(); this.parentElement.parentElement.parentElement.remove();">
                    <i class="fas fa-download"></i> Fazer Backup Agora
                </button>
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove();" style="margin-left: 10px;">
                    Fechar
                </button>
            </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Fechar ao clicar fora
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // ============================================
    // FUNÇÃO PARA ATUALIZAR TODAS AS DISPLAYS
    // ============================================

    function updateAllDisplays() {
        // Atualiza todas as partes da interface
        updateDashboard();
        updateHydrationDisplay();
        updateFlashcardDisplay();
        loadMealPlan();
        updateStudySessions();
        loadTasks();
        loadNotes();
        updateProgressChart();
        updateSubjectsProgress();
        updateSessionsHistory();
        updateWeeklyTotal();
        updateGoalsProgress();
        updateAnthropometricHistory();
        updateSubjectSelect();
        updateSavedCalculations();
        
        // Atualiza metas
        if (userData.hydration) {
            document.getElementById('water-goal-display').textContent = userData.hydration.goal;
            document.getElementById('water-goal-input').value = userData.hydration.goal;
        }
        
        if (userData.studyProgress) {
            document.getElementById('daily-goal-input').value = userData.studyProgress.dailyGoal;
            document.getElementById('weekly-goal-input').value = userData.studyProgress.weeklyGoal;
        }
        
        // Data atual no formulário antropométrico
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('assessment-date').value = today;
    }

    // ============================================
    // INICIALIZAÇÃO
    // ============================================

    // Auto-save quando o usuário sai da página
    window.addEventListener('beforeunload', function() {
        saveData();
    });

    // Auto-save a cada 30 segundos (se houver mudanças)
    let hasUnsavedChanges = false;
    setInterval(() => {
        if (hasUnsavedChanges) {
            saveData();
            hasUnsavedChanges = false;
        }
    }, 30000);

    // Marca quando há mudanças
    function markChanges() {
        hasUnsavedChanges = true;
    }

    // Inicialização quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 NutriStudy iniciando...');
        
        // Carrega dados
        loadData();
        
        // Configura evento para salvar em TODAS as ações
        document.addEventListener('click', function(e) {
            if (e.target.matches('button, input, select, textarea')) {
                setTimeout(markChanges, 100);
            }
        });
        
        // Inputs também marcam mudanças
        document.addEventListener('input', markChanges);
        document.addEventListener('change', markChanges);
        
        // Inicializa outras partes
        setTimeout(() => {
            // Inicializa gráfico de macros
            if (typeof initializeMacrosChart === 'function') {
                initializeMacrosChart();
            }
            
            // Configura data de prova
            const nextExamDate = new Date();
            nextExamDate.setDate(nextExamDate.getDate() + 15);
            const nextExamElement = document.getElementById('next-exam');
            if (nextExamElement) {
                nextExamElement.textContent = 
                    `Fisiologia - ${nextExamDate.toLocaleDateString('pt-BR')}`;
            }
            
            console.log('✅ NutriStudy totalmente carregado!');
            
            // Mostra quantidade de dados carregados
            const loadInfo = document.createElement('div');
            loadInfo.style.cssText = `
                position: fixed;
                bottom: 10px;
                left: 10px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.8rem;
                z-index: 10000;
            `;
            loadInfo.textContent = `Carregado: ${userData.notes?.length || 0} notas, ${userData.flashcards?.length || 0} flashcards`;
            document.body.appendChild(loadInfo);
            
            setTimeout(() => loadInfo.remove(), 5000);
            
        }, 500);
    });

    // ============================================
    // AGORA VOU MANTER TODAS AS SUAS FUNÇÕES ORIGINAIS
    // MAS VOU MODIFICAR PARA CHAMAR saveData() E markChanges()
    // ============================================

    // Timer variables
    let timerInterval;
    let timeLeft = 25 * 60;
    let isRunning = false;
    let currentMode = 'stopped';
    let studyTimerActive = false;

    // Flashcards variables
    let currentFlashcardIndex = 0;

    // Tool switching functionality
    document.querySelectorAll('.tool-btn').forEach(button => {
        button.addEventListener('click', function() {
            const toolId = this.getAttribute('data-tool');
            
            // Update active button
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Show selected tool
            document.querySelectorAll('.tool-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById(toolId).classList.add('active');
            
            // Initialize specific tool if needed
            if (toolId === 'macros') {
                setTimeout(initializeMacrosChart, 100);
            }
            
            markChanges(); // MARCA MUDANÇA
        });
    });

    // Switch tool programmatically
    function switchTool(toolId) {
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        const toolBtn = document.querySelector(`[data-tool="${toolId}"]`);
        if (toolBtn) {
            toolBtn.classList.add('active');
        }
        
        document.querySelectorAll('.tool-container').forEach(container => {
            container.classList.remove('active');
        });
        const toolContainer = document.getElementById(toolId);
        if (toolContainer) {
            toolContainer.classList.add('active');
        }
        
        // Initialize specific tool if needed
        if (toolId === 'macros') {
            setTimeout(initializeMacrosChart, 100);
        }
        
        markChanges(); // MARCA MUDANÇA
    }

    // Update dashboard with current data
    function updateDashboard() {
        if (!userData.hydration) return;
        
        const hydrationPercent = Math.min((userData.hydration.current / userData.hydration.goal) * 100, 100);
        document.getElementById('hydration-status').textContent = `${userData.hydration.current}/${userData.hydration.goal}ml`;
        const hydrationProgress = document.getElementById('hydration-progress');
        if (hydrationProgress) {
            hydrationProgress.style.width = `${hydrationPercent}%`;
        }
        
        // Update study today
        const studyToday = userData.studyProgress?.daily || 0;
        document.getElementById('study-today').textContent = `${studyToday} minutos`;
    }

    // TASK MANAGEMENT FUNCTIONS
    function loadTasks() {
        const taskList = document.getElementById('task-list');
        if (!taskList) return;
        
        taskList.innerHTML = '';
        
        if (!userData.tasks || !Array.isArray(userData.tasks)) {
            userData.tasks = [];
        }
        
        userData.tasks.forEach(task => {
            const taskItem = document.createElement('li');
            taskItem.className = 'task-item';
            taskItem.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
                <span class="task-text ${task.completed ? 'completed' : ''}" contenteditable="true" onblur="updateTaskText(${task.id}, this.textContent)">${task.text}</span>
                <div class="task-actions">
                    <button class="delete-btn" onclick="deleteTask(${task.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            taskList.appendChild(taskItem);
        });
    }
    
    function addTask() {
        const newTaskInput = document.getElementById('new-task');
        if (!newTaskInput) return;
        
        const taskText = newTaskInput.value.trim();
        
        if (!taskText) {
            alert('Por favor, digite uma tarefa!');
            return;
        }
        
        if (!userData.tasks) userData.tasks = [];
        
        const newId = userData.tasks.length > 0 ? Math.max(...userData.tasks.map(t => t.id)) + 1 : 1;
        userData.tasks.push({
            id: newId,
            text: taskText,
            completed: false
        });
        
        saveData(); // SALVA DIRETAMENTE
        loadTasks();
        newTaskInput.value = '';
    }
    
    function toggleTask(taskId) {
        const task = userData.tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            saveData(); // SALVA DIRETAMENTE
            loadTasks();
        }
    }
    
    function updateTaskText(taskId, newText) {
        const task = userData.tasks.find(t => t.id === taskId);
        if (task && newText.trim()) {
            task.text = newText.trim();
            saveData(); // SALVA DIRETAMENTE
            loadTasks();
        }
    }
    
    function deleteTask(taskId) {
        userData.tasks = userData.tasks.filter(t => t.id !== taskId);
        saveData(); // SALVA DIRETAMENTE
        loadTasks();
    }

    // Calculate calories function
    function calculateCalories() {
        const protein = parseFloat(document.getElementById('protein').value) || 0;
        const carbs = parseFloat(document.getElementById('carbs').value) || 0;
        const fat = parseFloat(document.getElementById('fat').value) || 0;
        const foodName = document.getElementById('food-name').value || "Alimento";
        
        // Calories: 4 kcal/g for protein and carbs, 9 kcal/g for fat
        const calories = (protein * 4) + (carbs * 4) + (fat * 9);
        
        const resultDiv = document.getElementById('calories-result');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <strong>${foodName}</strong><br>
                ${calories.toFixed(0)} kcal<br>
                <small>P: ${protein}g | C: ${carbs}g | G: ${fat}g</small>
            `;
        }
        
        // Store current calculation for saving
        window.currentCalculation = { foodName, protein, carbs, fat, calories };
        markChanges(); // MARCA MUDANÇA
    }

    // Save calculation
    function saveCalculation() {
        if (!window.currentCalculation) {
            alert('Primeiro realize um cálculo para salvar!');
            return;
        }
        
        if (!userData.calculations) userData.calculations = [];
        
        userData.calculations.push(window.currentCalculation);
        saveData(); // SALVA DIRETAMENTE
        updateSavedCalculations();
        
        // Show success message
        const resultDiv = document.getElementById('calories-result');
        if (resultDiv) {
            resultDiv.innerHTML += 
                '<div class="alert alert-success mt-3">Cálculo salvo com sucesso!</div>';
        }
    }

    // Update saved calculations display
    function updateSavedCalculations() {
        const container = document.getElementById('saved-calculations');
        if (!container) return;
        
        if (!userData.calculations || userData.calculations.length === 0) {
            container.innerHTML = '<p class="alert alert-info">Nenhum cálculo salvo ainda. Realize um cálculo e salve-o aqui.</p>';
            return;
        }
        
        let html = '<table><thead><tr><th>Alimento</th><th>Calorias</th><th>Detalhes</th><th>Ação</th></tr></thead><tbody>';
        
        userData.calculations.slice(-5).forEach((calc, index) => {
            html += `
                <tr>
                    <td>${calc.foodName}</td>
                    <td>${calc.calories.toFixed(0)} kcal</td>
                    <td>P:${calc.protein}g C:${calc.carbs}g G:${calc.fat}g</td>
                    <td><button class="delete-btn" onclick="deleteCalculation(${index})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    function deleteCalculation(index) {
        if (confirm('Tem certeza que deseja excluir este cálculo?')) {
            userData.calculations.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            updateSavedCalculations();
        }
    }
    
    function deleteAllCalculations() {
        if (confirm('Tem certeza que deseja apagar TODOS os cálculos salvos?')) {
            userData.calculations = [];
            saveData(); // SALVA DIRETAMENTE
            updateSavedCalculations();
        }
    }

    // Flashcards functionality
    function toggleFlashcard() {
        const flashcard = document.getElementById('flashcard');
        if (flashcard) {
            flashcard.classList.toggle('flipped');
        }
    }

    // Update flashcard display
    function updateFlashcardDisplay() {
        if (!userData.flashcards || userData.flashcards.length === 0) {
            document.getElementById('flashcard-question').textContent = "Nenhum flashcard disponível";
            document.getElementById('flashcard-answer').textContent = "Adicione novos flashcards para estudar";
            document.getElementById('flashcard-counter').textContent = "0/0";
            return;
        }
        
        const card = userData.flashcards[currentFlashcardIndex];
        document.getElementById('flashcard-question').textContent = card.question;
        document.getElementById('flashcard-answer').textContent = card.answer;
        document.getElementById('flashcard-counter').textContent = `${currentFlashcardIndex + 1}/${userData.flashcards.length}`;
        
        // Ensure card is not flipped when changing
        const flashcard = document.getElementById('flashcard');
        if (flashcard) {
            flashcard.classList.remove('flipped');
        }
    }

    // Navigate flashcards
    function nextFlashcard() {
        if (!userData.flashcards || userData.flashcards.length === 0) return;
        currentFlashcardIndex = (currentFlashcardIndex + 1) % userData.flashcards.length;
        updateFlashcardDisplay();
    }

    function prevFlashcard() {
        if (!userData.flashcards || userData.flashcards.length === 0) return;
        currentFlashcardIndex = (currentFlashcardIndex - 1 + userData.flashcards.length) % userData.flashcards.length;
        updateFlashcardDisplay();
    }

    // Add new flashcard
    function addFlashcard() {
        const question = document.getElementById('new-question').value;
        const answer = document.getElementById('new-answer').value;
        
        if (!question.trim() || !answer.trim()) {
            alert('Por favor, preencha tanto a pergunta quanto a resposta!');
            return;
        }
        
        if (!userData.flashcards) userData.flashcards = [];
        
        userData.flashcards.push({ question, answer });
        saveData(); // SALVA DIRETAMENTE
        
        // Update display
        currentFlashcardIndex = userData.flashcards.length - 1;
        updateFlashcardDisplay();
        
        // Clear form
        document.getElementById('new-question').value = '';
        document.getElementById('new-answer').value = '';
        
        // Show success message
        alert('Flashcard adicionado com sucesso!');
    }
    
    function deleteCurrentFlashcard() {
        if (!userData.flashcards || userData.flashcards.length === 0) {
            alert('Não há flashcards para apagar!');
            return;
        }
        
        if (confirm('Tem certeza que deseja apagar este flashcard?')) {
            userData.flashcards.splice(currentFlashcardIndex, 1);
            
            // Adjust current index if needed
            if (currentFlashcardIndex >= userData.flashcards.length) {
                currentFlashcardIndex = Math.max(0, userData.flashcards.length - 1);
            }
            
            saveData(); // SALVA DIRETAMENTE
            updateFlashcardDisplay();
        }
    }

    // Hydration tracker functions
    function addWater(amount) {
        if (!userData.hydration) userData.hydration = { current: 0, goal: 2000, history: [] };
        
        userData.hydration.current += amount;
        
        // Don't exceed goal in display
        if (userData.hydration.current > userData.hydration.goal) {
            userData.hydration.current = userData.hydration.goal;
        }
        
        saveData(); // SALVA DIRETAMENTE
        updateHydrationDisplay();
        updateDashboard();
    }

    function resetWater() {
        if (!userData.hydration) userData.hydration = { current: 0, goal: 2000, history: [] };
        
        // Save today's data to history
        const today = new Date().toLocaleDateString('pt-BR');
        
        if (!userData.hydration.history) userData.hydration.history = [];
        
        userData.hydration.history.push({
            date: today,
            amount: userData.hydration.current,
            goal: userData.hydration.goal
        });
        
        // Keep only last 7 days
        if (userData.hydration.history.length > 7) {
            userData.hydration.history = userData.hydration.history.slice(-7);
        }
        
        // Reset for today
        userData.hydration.current = 0;
        
        saveData(); // SALVA DIRETAMENTE
        updateHydrationDisplay();
        updateDashboard();
        updateHydrationHistory();
    }
    
    function updateWaterGoal() {
        const newGoal = parseInt(document.getElementById('water-goal-input').value);
        
        if (newGoal && newGoal > 0) {
            if (!userData.hydration) userData.hydration = { current: 0, goal: 2000, history: [] };
            
            userData.hydration.goal = newGoal;
            saveData(); // SALVA DIRETAMENTE
            updateHydrationDisplay();
            updateDashboard();
            alert(`Meta de água atualizada para ${newGoal}ml por dia!`);
        } else {
            alert('Por favor, insira uma meta válida (maior que 0).');
        }
    }

    function updateHydrationDisplay() {
        if (!userData.hydration) return;
        
        const percent = Math.min((userData.hydration.current / userData.hydration.goal) * 100, 100);
        
        const waterAmount = document.getElementById('water-amount');
        const waterProgress = document.getElementById('water-progress');
        const waterGoalDisplay = document.getElementById('water-goal-display');
        
        if (waterAmount) waterAmount.textContent = `${userData.hydration.current}ml`;
        if (waterProgress) waterProgress.style.width = `${percent}%`;
        if (waterGoalDisplay) waterGoalDisplay.textContent = userData.hydration.goal;
    }

    function updateHydrationHistory() {
        const container = document.getElementById('hydration-history');
        if (!container) return;
        
        if (!userData.hydration || !userData.hydration.history || userData.hydration.history.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum histórico disponível</td></tr>';
            return;
        }
        
        let html = '';
        userData.hydration.history.forEach((day, index) => {
            const achieved = day.amount >= day.goal ? '✓' : '✗';
            
            html += `
                <tr>
                    <td>${day.date}</td>
                    <td>${day.amount}ml</td>
                    <td style="color: ${day.amount >= day.goal ? 'green' : 'red'}">${achieved}</td>
                    <td><button class="delete-btn" onclick="deleteHydrationHistoryItem(${index})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function deleteHydrationHistoryItem(index) {
        if (confirm('Tem certeza que deseja excluir este registro?')) {
            userData.hydration.history.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            updateHydrationHistory();
        }
    }
    
    function deleteAllHydrationHistory() {
        if (confirm('Tem certeza que deseja apagar TODO o histórico de hidratação?')) {
            userData.hydration.history = [];
            saveData(); // SALVA DIRETAMENTE
            updateHydrationHistory();
        }
    }

    function setHydrationReminder() {
        const interval = parseInt(document.getElementById('reminder-interval').value) * 60 * 1000;
        
        if (Notification.permission === "granted") {
            setInterval(() => {
                new Notification("NutriStudy - Hidratação", {
                    body: "Hora de beber água! Mantenha-se hidratada para melhor desempenho nos estudos.",
                    icon: "https://cdn-icons-png.flaticon.com/512/3095/3095113.png"
                });
            }, interval);
            
            alert(`Lembretes ativados a cada ${interval/60000} minutos!`);
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    setHydrationReminder();
                }
            });
        }
    }

    // Meal planner functions
    function loadMealPlan() {
        const day = document.getElementById('week-day').value;
        const container = document.getElementById('meal-plan-content');
        if (!container) return;
        
        // Check if we have a meal plan for this day
        if (!userData.mealPlans) userData.mealPlans = {};
        
        if (!userData.mealPlans[day]) {
            userData.mealPlans[day] = [];
        }
        
        let html = '<h3>Refeições do Dia</h3>';
        
        if (userData.mealPlans[day].length === 0) {
            html += '<p class="alert alert-info">Nenhuma refeição planejada para este dia. Adicione abaixo.</p>';
        } else {
            // Group meals by type
            const mealTypes = {
                'cafe': 'Café da Manhã',
                'lanche1': 'Lanche da Manhã',
                'almoco': 'Almoço',
                'lanche2': 'Lanche da Tarde',
                'jantar': 'Jantar',
                'ceia': 'Ceia'
            };
            
            let totalCalories = 0;
            
            Object.entries(mealTypes).forEach(([key, label]) => {
                const meals = userData.mealPlans[day].filter(meal => meal.type === key);
                
                if (meals.length > 0) {
                    html += `<div class="meal-plan-day"><h4>${label}</h4>`;
                    
                    meals.forEach((meal, index) => {
                        html += `
                            <div class="meal-item">
                                <span>${meal.description}</span>
                                <span>${meal.calories} kcal</span>
                                <button class="delete-btn" onclick="deleteMeal('${day}', ${index})"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        totalCalories += meal.calories;
                    });
                    
                    html += '</div>';
                }
            });
            
            html += `<div class="card mt-3"><h4>Total de Calorias: ${totalCalories} kcal</h4></div>`;
        }
        
        container.innerHTML = html;
    }
    
    function deleteMeal(day, index) {
        if (confirm('Tem certeza que deseja excluir esta refeição?')) {
            userData.mealPlans[day].splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            loadMealPlan();
        }
    }
    
    function deleteAllMealsForDay() {
        const day = document.getElementById('week-day').value;
        
        if (!userData.mealPlans || !userData.mealPlans[day] || userData.mealPlans[day].length === 0) {
            alert('Não há refeições para apagar neste dia!');
            return;
        }
        
        if (confirm('Tem certeza que deseja apagar TODAS as refeições deste dia?')) {
            userData.mealPlans[day] = [];
            saveData(); // SALVA DIRETAMENTE
            loadMealPlan();
        }
    }

    function addMeal() {
        const day = document.getElementById('week-day').value;
        const type = document.getElementById('meal-type').value;
        const description = document.getElementById('meal-description').value;
        const calories = parseInt(document.getElementById('meal-calories').value) || 0;
        
        if (!description.trim()) {
            alert('Por favor, descreva a refeição!');
            return;
        }
        
        if (!userData.mealPlans) userData.mealPlans = {};
        
        // Initialize day array if needed
        if (!userData.mealPlans[day]) {
            userData.mealPlans[day] = [];
        }
        
        // Add meal
        userData.mealPlans[day].push({
            type,
            description,
            calories,
            id: Date.now()
        });
        
        saveData(); // SALVA DIRETAMENTE
        loadMealPlan();
        
        // Clear form
        document.getElementById('meal-description').value = '';
        document.getElementById('meal-calories').value = '';
        
        // Show success
        const container = document.getElementById('meal-plan-content');
        if (container) {
            container.innerHTML += 
                '<div class="alert alert-success mt-3">Refeição adicionada com sucesso!</div>';
        }
    }

    // BMI Calculator
    function calculateBMI() {
        const weight = parseFloat(document.getElementById('weight').value);
        const height = parseFloat(document.getElementById('height').value) / 100; // convert cm to m
        
        if (!weight || !height || height <= 0) {
            alert('Por favor, insira valores válidos para peso e altura.');
            return;
        }
        
        const bmi = weight / (height * height);
        let classification = '';
        let color = '';
        
        if (bmi < 18.5) {
            classification = 'Abaixo do peso';
            color = '#FF9800';
        } else if (bmi < 25) {
            classification = 'Peso normal';
            color = '#4CAF50';
        } else if (bmi < 30) {
            classification = 'Sobrepeso';
            color = '#FF9800';
        } else {
            classification = 'Obesidade';
            color = '#F44336';
        }
        
        const resultDiv = document.getElementById('bmi-result');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div style="text-align: center;">
                    <h3>Seu IMC é:</h3>
                    <div style="font-size: 3rem; font-weight: bold; color: ${color}">${bmi.toFixed(1)}</div>
                    <p style="font-size: 1.2rem; margin-top: 10px;">Classificação: <strong>${classification}</strong></p>
                    <small>De acordo com a OMS (Organização Mundial da Saúde)</small>
                </div>
            `;
        }
        
        // Save to history
        if (!userData.bmiHistory) userData.bmiHistory = [];
        
        userData.bmiHistory.push({
            date: new Date().toLocaleDateString('pt-BR'),
            weight,
            height: height * 100,
            bmi: bmi.toFixed(1),
            classification
        });
        
        saveData(); // SALVA DIRETAMENTE
    }
    
    function deleteAllBMIHistory() {
        if (confirm('Tem certeza que deseja apagar TODO o histórico de IMC?')) {
            userData.bmiHistory = [];
            saveData(); // SALVA DIRETAMENTE
            alert('Histórico de IMC apagado com sucesso!');
        }
    }

    // Macronutrients Calculator
    function calculateMacros() {
        const dailyCalories = parseFloat(document.getElementById('daily-calories').value);
        const goal = document.getElementById('goal').value;
        
        if (!dailyCalories || dailyCalories <= 0) {
            alert('Por favor, insira um valor válido para calorias diárias.');
            return;
        }
        
        let proteinPercent, carbsPercent, fatPercent;
        
        switch(goal) {
            case 'maintenance':
                proteinPercent = 0.25; // 25%
                carbsPercent = 0.50;   // 50%
                fatPercent = 0.25;     // 25%
                break;
            case 'loss':
                proteinPercent = 0.30; // 30%
                carbsPercent = 0.40;   // 40%
                fatPercent = 0.30;     // 30%
                break;
            case 'gain':
                proteinPercent = 0.30; // 30%
                carbsPercent = 0.50;   // 50%
                fatPercent = 0.20;     // 20%
                break;
        }
        
        const proteinCalories = dailyCalories * proteinPercent;
        const carbsCalories = dailyCalories * carbsPercent;
        const fatCalories = dailyCalories * fatPercent;
        
        const proteinGrams = proteinCalories / 4;
        const carbsGrams = carbsCalories / 4;
        const fatGrams = fatCalories / 9;
        
        // Update result display
        const macrosDetails = document.getElementById('macros-details');
        const macrosResult = document.getElementById('macros-result');
        
        if (macrosDetails) {
            macrosDetails.innerHTML = `
                <p><strong>Proteínas:</strong> ${proteinGrams.toFixed(0)}g (${(proteinPercent*100).toFixed(0)}%)</p>
                <p><strong>Carboidratos:</strong> ${carbsGrams.toFixed(0)}g (${(carbsPercent*100).toFixed(0)}%)</p>
                <p><strong>Gorduras:</strong> ${fatGrams.toFixed(0)}g (${(fatPercent*100).toFixed(0)}%)</p>
                <p><strong>Total:</strong> ${dailyCalories} kcal</p>
            `;
        }
        
        if (macrosResult) {
            macrosResult.style.display = 'block';
        }
        
        // Update chart
        updateMacrosChart(proteinPercent, carbsPercent, fatPercent);
        markChanges(); // MARCA MUDANÇA
    }
    
    function initializeMacrosChart() {
        // Initialize with default values
        updateMacrosChart(0.25, 0.50, 0.25);
    }
    
    function updateMacrosChart(proteinPercent, carbsPercent, fatPercent) {
        const canvas = document.getElementById('macros-chart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw pie chart
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;
        
        let startAngle = 0;
        
        // Protein slice (green)
        const proteinAngle = proteinPercent * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + proteinAngle);
        ctx.closePath();
        ctx.fillStyle = '#4CAF50';
        ctx.fill();
        
        // Draw protein label
        const proteinMidAngle = startAngle + proteinAngle / 2;
        const proteinTextRadius = radius * 0.6;
        const proteinTextX = centerX + Math.cos(proteinMidAngle) * proteinTextRadius;
        const proteinTextY = centerY + Math.sin(proteinMidAngle) * proteinTextRadius;
        
        ctx.save();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Proteína', proteinTextX, proteinTextY);
        ctx.restore();
        
        startAngle += proteinAngle;
        
        // Carbs slice (blue)
        const carbsAngle = carbsPercent * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + carbsAngle);
        ctx.closePath();
        ctx.fillStyle = '#2196F3';
        ctx.fill();
        
        // Draw carbs label
        const carbsMidAngle = startAngle + carbsAngle / 2;
        const carbsTextRadius = radius * 0.6;
        const carbsTextX = centerX + Math.cos(carbsMidAngle) * carbsTextRadius;
        const carbsTextY = centerY + Math.sin(carbsMidAngle) * carbsTextRadius;
        
        ctx.save();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Carbo', carbsTextX, carbsTextY);
        ctx.restore();
        
        startAngle += carbsAngle;
        
        // Fat slice (orange)
        const fatAngle = fatPercent * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + fatAngle);
        ctx.closePath();
        ctx.fillStyle = '#FF9800';
        ctx.fill();
        
        // Draw fat label
        const fatMidAngle = startAngle + fatAngle / 2;
        const fatTextRadius = radius * 0.6;
        const fatTextX = centerX + Math.cos(fatMidAngle) * fatTextRadius;
        const fatTextY = centerY + Math.sin(fatMidAngle) * fatTextRadius;
        
        ctx.save();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 13px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Gordura', fatTextX, fatTextY);
        ctx.restore();
        
        // Legenda simples na parte inferior
        const legendY = canvas.height - 20;
        
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(centerX - 100, legendY - 40, 15, 15);
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(`Proteína: ${(proteinPercent*100).toFixed(0)}%`, centerX - 80, legendY - 30);
        
        ctx.fillStyle = '#2196F3';
        ctx.fillRect(centerX - 100, legendY - 20, 15, 15);
        ctx.fillStyle = '#333';
        ctx.fillText(`Carboidrato: ${(carbsPercent*100).toFixed(0)}%`, centerX - 80, legendY - 10);
        
        ctx.fillStyle = '#FF9800';
        ctx.fillRect(centerX - 100, legendY, 15, 15);
        ctx.fillStyle = '#333';
        ctx.fillText(`Gordura: ${(fatPercent*100).toFixed(0)}%`, centerX - 80, legendY + 10);
    }

    // ANTHROPOMETRIC ASSESSMENT FUNCTIONS
    function calculateAnthropometric() {
        const patientName = document.getElementById('patient-name').value;
        const date = document.getElementById('assessment-date').value;
        const weight = parseFloat(document.getElementById('anthro-weight').value);
        const height = parseFloat(document.getElementById('anthro-height').value);
        const age = parseInt(document.getElementById('anthro-age').value);
        const waist = parseFloat(document.getElementById('waist-circ').value);
        const hip = parseFloat(document.getElementById('hip-circ').value);
        const arm = parseFloat(document.getElementById('arm-circ').value);
        const triceps = parseFloat(document.getElementById('triceps-sf').value);
        const subscapular = parseFloat(document.getElementById('subscapular-sf').value);
        const abdominal = parseFloat(document.getElementById('abdominal-sf').value);
        
        if (!patientName || !weight || !height) {
            alert('Por favor, preencha pelo menos nome do paciente, peso e altura.');
            return;
        }
        
        // Calculate metrics
        const bmi = weight / ((height/100) * (height/100));
        const waistHipRatio = waist / hip;
        const sumSkinfolds = (triceps || 0) + (subscapular || 0) + (abdominal || 0);
        
        // Estimate body fat percentage using Jackson & Pollock formula (simplified)
        let bodyFatPercentage = 0;
        if (sumSkinfolds > 0) {
            // Simplified calculation for demonstration
            bodyFatPercentage = (sumSkinfolds * 0.153) + 5.783;
        }
        
        // Classifications
        let bmiClassification = '';
        if (bmi < 18.5) bmiClassification = 'Baixo peso';
        else if (bmi < 25) bmiClassification = 'Peso normal';
        else if (bmi < 30) bmiClassification = 'Sobrepeso';
        else bmiClassification = 'Obesidade';
        
        let whrClassification = '';
        if (waistHipRatio <= 0.85) whrClassification = 'Normal';
        else if (waistHipRatio <= 0.90) whrClassification = 'Moderado';
        else whrClassification = 'Alto risco cardiovascular';
        
        let bodyFatClassification = '';
        if (bodyFatPercentage > 0) {
            if (bodyFatPercentage < 20) bodyFatClassification = 'Baixo';
            else if (bodyFatPercentage < 25) bodyFatClassification = 'Normal';
            else if (bodyFatPercentage < 32) bodyFatClassification = 'Moderado';
            else bodyFatClassification = 'Alto';
        }
        
        // Display results
        const resultsDiv = document.getElementById('anthro-results');
        if (resultsDiv) {
            resultsDiv.innerHTML = `
                <h4>Resultados para ${patientName}</h4>
                <p><strong>Data:</strong> ${date}</p>
                <p><strong>IMC:</strong> ${bmi.toFixed(1)} kg/m² - ${bmiClassification}</p>
                <p><strong>Relação Cintura/Quadril:</strong> ${waistHipRatio.toFixed(2)} - ${whrClassification}</p>
                ${bodyFatPercentage > 0 ? `<p><strong>% Gordura Corporal (estimado):</strong> ${bodyFatPercentage.toFixed(1)}% - ${bodyFatClassification}</p>` : ''}
                <p><strong>Circunferência do Braço:</strong> ${arm || '--'} cm</p>
                <p><strong>Soma das Dobras Cutâneas:</strong> ${sumSkinfolds.toFixed(1)} mm</p>
            `;
            resultsDiv.style.display = 'block';
        }
        
        // Save assessment
        if (!userData.anthropometricAssessments) userData.anthropometricAssessments = [];
        
        const assessment = {
            id: Date.now(),
            patientName,
            date,
            weight,
            height,
            age: age || null,
            waist,
            hip,
            arm,
            triceps,
            subscapular,
            abdominal,
            bmi: bmi.toFixed(1),
            waistHipRatio: waistHipRatio.toFixed(2),
            bodyFatPercentage: bodyFatPercentage > 0 ? bodyFatPercentage.toFixed(1) : null,
            bmiClassification,
            whrClassification,
            bodyFatClassification
        };
        
        userData.anthropometricAssessments.unshift(assessment);
        saveData(); // SALVA DIRETAMENTE
        updateAnthropometricHistory();
        
        // Clear form
        document.getElementById('patient-name').value = '';
        document.getElementById('anthro-weight').value = '';
        document.getElementById('anthro-height').value = '';
        document.getElementById('anthro-age').value = '';
        document.getElementById('waist-circ').value = '';
        document.getElementById('hip-circ').value = '';
        document.getElementById('arm-circ').value = '';
        document.getElementById('triceps-sf').value = '';
        document.getElementById('subscapular-sf').value = '';
        document.getElementById('abdominal-sf').value = '';
    }
    
    function updateAnthropometricHistory() {
        const container = document.getElementById('anthro-history');
        if (!container) return;
        
        if (!userData.anthropometricAssessments || userData.anthropometricAssessments.length === 0) {
            container.innerHTML = '<p class="alert alert-info">Nenhuma avaliação realizada ainda.</p>';
            return;
        }
        
        let html = '';
        userData.anthropometricAssessments.forEach((assessment, index) => {
            html += `
                <div class="measurement-card">
                    <div class="measurement-header">
                        <h5>${assessment.patientName}</h5>
                        <div>
                            <small>${assessment.date}</small>
                            <button class="delete-btn" onclick="deleteAnthropometricAssessment(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="measurement-values">
                        <div class="measurement-value">
                            <span class="measurement-label">IMC</span>
                            <span class="measurement-number">${assessment.bmi}</span>
                        </div>
                        <div class="measurement-value">
                            <span class="measurement-label">C/Q</span>
                            <span class="measurement-number">${assessment.waistHipRatio}</span>
                        </div>
                        ${assessment.bodyFatPercentage ? `
                        <div class="measurement-value">
                            <span class="measurement-label">% Gordura</span>
                            <span class="measurement-number">${assessment.bodyFatPercentage}%</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function deleteAnthropometricAssessment(index) {
        if (confirm('Tem certeza que deseja excluir esta avaliação?')) {
            userData.anthropometricAssessments.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            updateAnthropometricHistory();
        }
    }
    
    function deleteAllAnthropometricHistory() {
        if (confirm('Tem certeza que deseja apagar TODO o histórico de avaliações antropométricas?')) {
            userData.anthropometricAssessments = [];
            saveData(); // SALVA DIRETAMENTE
            updateAnthropometricHistory();
        }
    }

    // Notes functions
    function loadNotes() {
        const notesList = document.getElementById('notes-list');
        if (!notesList) return;
        
        if (!userData.notes || userData.notes.length === 0) {
            notesList.innerHTML = '<p class="alert alert-info">Nenhuma anotação salva ainda. Adicione sua primeira anotação!</p>';
            return;
        }
        
        let html = '';
        userData.notes.forEach((note, index) => {
            const subjectNames = {
                'bioquimica': 'Bioquímica',
                'fisiologia': 'Fisiologia',
                'dietetica': 'Dietética',
                'nutricaohumana': 'Nutrição Humana',
                'bromatologia': 'Bromatologia',
                'outro': 'Outro'
            };
            
            html += `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h4>${note.title}</h4>
                        <button class="delete-btn" onclick="deleteNote(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                    <p><strong>Disciplina:</strong> ${subjectNames[note.subject] || note.subject}</p>
                    <p>${note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <small>${note.date}</small>
                        <div>
                            <button class="btn btn-small" onclick="viewNote(${index})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        notesList.innerHTML = html;
    }
    
    function addNote() {
        const subject = document.getElementById('note-subject').value;
        const title = document.getElementById('note-title').value;
        const content = document.getElementById('note-content').value;
        
        if (!title.trim() || !content.trim()) {
            alert('Por favor, preencha o título e o conteúdo da anotação!');
            return;
        }
        
        if (!userData.notes) userData.notes = [];
        
        const newNote = {
            subject,
            title,
            content,
            date: new Date().toLocaleDateString('pt-BR'),
            id: Date.now()
        };
        
        userData.notes.unshift(newNote);
        saveData(); // SALVA DIRETAMENTE
        loadNotes();
        
        // Clear form
        document.getElementById('note-title').value = '';
        document.getElementById('note-content').value = '';
        
        alert('Anotação salva com sucesso!');
    }
    
    function searchNotes() {
        const searchTerm = document.getElementById('note-search').value.toLowerCase();
        const notesList = document.getElementById('notes-list');
        
        if (!searchTerm) {
            loadNotes();
            return;
        }
        
        if (!userData.notes) return;
        
        const filteredNotes = userData.notes.filter(note => 
            note.title.toLowerCase().includes(searchTerm) || 
            note.content.toLowerCase().includes(searchTerm) ||
            note.subject.toLowerCase().includes(searchTerm)
        );
        
        if (filteredNotes.length === 0) {
            notesList.innerHTML = '<p class="alert alert-info">Nenhuma anotação encontrada para sua pesquisa.</p>';
            return;
        }
        
        let html = '';
        filteredNotes.forEach((note, index) => {
            const originalIndex = userData.notes.findIndex(n => n.id === note.id);
            const subjectNames = {
                'bioquimica': 'Bioquímica',
                'fisiologia': 'Fisiologia',
                'dietetica': 'Dietética',
                'nutricaohumana': 'Nutrição Humana',
                'bromatologia': 'Bromatologia',
                'outro': 'Outro'
            };
            
            html += `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h4>${note.title}</h4>
                        <button class="delete-btn" onclick="deleteNote(${originalIndex})"><i class="fas fa-trash"></i></button>
                    </div>
                    <p><strong>Disciplina:</strong> ${subjectNames[note.subject] || note.subject}</p>
                    <p>${note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <small>${note.date}</small>
                        <div>
                            <button class="btn btn-small" onclick="viewNote(${originalIndex})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        notesList.innerHTML = html;
    }
    
    function viewNote(index) {
        const note = userData.notes[index];
        const subjectNames = {
            'bioquimica': 'Bioquímica',
            'fisiologia': 'Fisiologia',
            'dietetica': 'Dietética',
            'nutricaohumana': 'Nutrição Humana',
            'bromatologia': 'Bromatologia',
            'outro': 'Outro'
        };
        
        alert(`Título: ${note.title}\nDisciplina: ${subjectNames[note.subject] || note.subject}\nData: ${note.date}\n\nConteúdo:\n${note.content}`);
    }
    
    function deleteNote(index) {
        if (confirm('Tem certeza que deseja excluir esta anotação?')) {
            userData.notes.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            loadNotes();
        }
    }
    
    function deleteAllNotes() {
        if (confirm('Tem certeza que deseja apagar TODAS as anotações?')) {
            userData.notes = [];
            saveData(); // SALVA DIRETAMENTE
            loadNotes();
        }
    }

    // Study timer functions
    function startStudyTimer() {
        if (isRunning && currentMode === 'study') {
            alert('O temporizador de estudo já está em execução!');
            return;
        }
        
        if (isRunning) {
            clearInterval(timerInterval);
        }
        
        timeLeft = 25 * 60; // 25 minutes
        currentMode = 'study';
        studyTimerActive = true;
        isRunning = true;
        
        const timerStatus = document.getElementById('timer-status');
        if (timerStatus) {
            timerStatus.textContent = 'Modo Estudo';
            timerStatus.style.color = 'var(--primary)';
        }
        
        updateTimerDisplay();
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                studyTimerActive = false;
                
                // Update study progress
                if (!userData.studyProgress) {
                    userData.studyProgress = {
                        daily: 0,
                        weekly: [0, 0, 0, 0, 0, 0, 0],
                        subjects: [],
                        dailyGoal: 120,
                        weeklyGoal: 840
                    };
                }
                
                userData.studyProgress.daily += 25;
                const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
                // Adjust for our array (0 = Monday)
                const arrayDay = today === 0 ? 6 : today - 1;
                userData.studyProgress.weekly[arrayDay] += 25;
                
                // Update study sessions
                userData.studySessions++;
                
                saveData(); // SALVA DIRETAMENTE
                updateStudySessions();
                updateDashboard();
                updateProgressChart();
                updateSubjectsProgress();
                updateWeeklyTotal();
                updateGoalsProgress();
                
                // Play sound (using a fallback if the URL fails)
                try {
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                    audio.play();
                } catch (e) {
                    console.log("Audio não pôde ser reproduzido");
                }
                
                // Show notification
                if (Notification.permission === "granted") {
                    new Notification('NutriStudy - Estudo', {
                        body: 'Tempo de estudo concluído! Hora de uma pausa.',
                        icon: 'https://cdn-icons-png.flaticon.com/512/3095/3095113.png'
                    });
                }
                
                alert('Tempo de estudo concluído! Hora de uma pausa.');
                
                // Auto-start break timer
                setTimeout(() => {
                    if (confirm('Iniciar pausa de 5 minutos?')) {
                        startBreakTimer();
                    }
                }, 500);
            }
        }, 1000);
    }
    
    function startBreakTimer() {
        if (isRunning && currentMode === 'break') {
            alert('O temporizador de pausa já está em execução!');
            return;
        }
        
        if (isRunning) {
            clearInterval(timerInterval);
        }
        
        timeLeft = 5 * 60; // 5 minutes
        currentMode = 'break';
        isRunning = true;
        
        const timerStatus = document.getElementById('timer-status');
        if (timerStatus) {
            timerStatus.textContent = 'Modo Pausa';
            timerStatus.style.color = 'var(--secondary)';
        }
        
        updateTimerDisplay();
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                
                // Play sound
                try {
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                    audio.play();
                } catch (e) {
                    console.log("Audio não pôde ser reproduzido");
                }
                
                // Show notification
                if (Notification.permission === "granted") {
                    new Notification('NutriStudy - Pausa', {
                        body: 'Pausa concluída! Hora de voltar aos estudos.',
                        icon: 'https://cdn-icons-png.flaticon.com/512/3095/3095113.png'
                    });
                }
                
                alert('Pausa concluída! Hora de voltar aos estudos.');
            }
        }, 1000);
    }

    function pauseTimer() {
        if (isRunning) {
            clearInterval(timerInterval);
            isRunning = false;
            const timerStatus = document.getElementById('timer-status');
            if (timerStatus) {
                timerStatus.textContent = 'Pausado';
                timerStatus.style.color = 'var(--danger)';
            }
        } else if (timeLeft > 0) {
            isRunning = true;
            const timerStatus = document.getElementById('timer-status');
            if (timerStatus) {
                timerStatus.textContent = currentMode === 'study' ? 'Modo Estudo' : 'Modo Pausa';
                timerStatus.style.color = currentMode === 'study' ? 'var(--primary)' : 'var(--secondary)';
            }
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    
                    if (currentMode === 'study') {
                        // Update study progress
                        if (!userData.studyProgress) {
                            userData.studyProgress = {
                                daily: 0,
                                weekly: [0, 0, 0, 0, 0, 0, 0],
                                subjects: [],
                                dailyGoal: 120,
                                weeklyGoal: 840
                            };
                        }
                        
                        userData.studyProgress.daily += 25;
                        const today = new Date().getDay();
                        const arrayDay = today === 0 ? 6 : today - 1;
                        userData.studyProgress.weekly[arrayDay] += 25;
                        userData.studySessions++;
                        
                        saveData(); // SALVA DIRETAMENTE
                        updateStudySessions();
                        updateDashboard();
                        updateProgressChart();
                        updateSubjectsProgress();
                        updateWeeklyTotal();
                        updateGoalsProgress();
                        
                        alert('Tempo de estudo concluído! Hora de uma pausa.');
                    } else {
                        alert('Pausa concluída! Hora de voltar aos estudos.');
                    }
                }
            }, 1000);
        }
    }
    
    function resetTimer() {
        if (isRunning) {
            clearInterval(timerInterval);
            isRunning = false;
        }
        
        if (currentMode === 'study') {
            timeLeft = 25 * 60;
        } else {
            timeLeft = 5 * 60;
        }
        
        const timerStatus = document.getElementById('timer-status');
        if (timerStatus) {
            timerStatus.textContent = 'Pronto para começar';
            timerStatus.style.color = 'var(--primary)';
        }
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function updateStudySessions() {
        const sessionsCount = document.getElementById('sessions-count');
        if (sessionsCount) {
            sessionsCount.textContent = userData.studySessions || 0;
        }
    }
    
    function updateSessionsHistory() {
        const container = document.getElementById('sessions-history');
        if (!container) return;
        
        if (!userData.sessionsHistory) userData.sessionsHistory = [];
        
        // Add today's session if it doesn't exist
        const today = new Date().toLocaleDateString('pt-BR');
        const todaySession = userData.sessionsHistory.find(s => s.date === today);
        
        if (!todaySession) {
            userData.sessionsHistory.unshift({
                date: today,
                sessions: userData.studySessions || 0,
                totalTime: userData.studyProgress?.daily || 0
            });
        } else {
            todaySession.sessions = userData.studySessions || 0;
            todaySession.totalTime = userData.studyProgress?.daily || 0;
        }
        
        // Keep only last 7 days
        userData.sessionsHistory = userData.sessionsHistory.slice(0, 7);
        
        if (userData.sessionsHistory.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum histórico disponível</td></tr>';
            return;
        }
        
        let html = '';
        userData.sessionsHistory.forEach((session, index) => {
            html += `
                <tr>
                    <td>${session.date}</td>
                    <td>${session.sessions}</td>
                    <td>${session.totalTime} minutos</td>
                    <td><button class="delete-btn" onclick="deleteSessionHistoryItem(${index})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
        
        container.innerHTML = html;
        saveData(); // SALVA DIRETAMENTE
    }
    
    function deleteSessionHistoryItem(index) {
        if (confirm('Tem certeza que deseja excluir este registro?')) {
            userData.sessionsHistory.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            updateSessionsHistory();
        }
    }
    
    function deleteAllSessionsHistory() {
        if (confirm('Tem certeza que deseja apagar TODO o histórico de sessões?')) {
            userData.sessionsHistory = [];
            saveData(); // SALVA DIRETAMENTE
            updateSessionsHistory();
        }
    }

    // Progress tracker functions
    function updateProgressChart() {
        const chartContainer = document.getElementById('progress-chart');
        if (!chartContainer) return;
        
        const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
        
        let html = '';
        
        if (!userData.studyProgress || !userData.studyProgress.weekly) {
            userData.studyProgress = {
                daily: 0,
                weekly: [0, 0, 0, 0, 0, 0, 0],
                subjects: [],
                dailyGoal: 120,
                weeklyGoal: 840
            };
        }
        
        const maxTime = Math.max(...userData.studyProgress.weekly, 60); // At least 60 minutes for scale
        
        userData.studyProgress.weekly.forEach((time, index) => {
            const height = maxTime > 0 ? (time / maxTime) * 150 : 0;
            html += `
                <div class="progress-day">
                    <div class="progress-bar-day" style="height: ${height}px; background-color: ${time > 0 ? 'var(--primary)' : '#E0E0E0'};"></div>
                    <div class="progress-label">${days[index]}</div>
                    <div class="progress-label">${time}m</div>
                </div>
            `;
        });
        
        chartContainer.innerHTML = html;
    }
    
    function updateSubjectsProgress() {
        const container = document.getElementById('subjects-progress');
        if (!container) return;
        
        if (!userData.studyProgress || !userData.studyProgress.subjects) {
            userData.studyProgress = {
                daily: 0,
                weekly: [0, 0, 0, 0, 0, 0, 0],
                subjects: [],
                dailyGoal: 120,
                weeklyGoal: 840
            };
        }
        
        let html = '';
        userData.studyProgress.subjects.forEach((subject, index) => {
            const percent = subject.goal > 0 ? Math.min((subject.time / subject.goal) * 100, 100) : 0;
            html += `
                <div class="mb-3">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>${subject.name}</strong></span>
                        <div>
                            <span>${subject.time}/${subject.goal} min</span>
                            <button class="delete-btn" onclick="deleteSubject(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${percent}%"></div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
                        <button class="btn btn-small" onclick="addTimeToSelectedSubject('${subject.name}', 30)">+30min</button>
                        <button class="btn btn-small" onclick="addTimeToSelectedSubject('${subject.name}', 60)">+60min</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        updateSubjectSelect();
    }
    
    function updateSubjectSelect() {
        const select = document.getElementById('subject-select');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione uma disciplina</option>';
        
        if (userData.studyProgress && userData.studyProgress.subjects) {
            userData.studyProgress.subjects.forEach(subject => {
                select.innerHTML += `<option value="${subject.name}">${subject.name}</option>`;
            });
        }
    }
    
    function addNewSubject() {
        const subjectName = document.getElementById('new-subject').value.trim();
        
        if (!subjectName) {
            alert('Por favor, digite o nome da disciplina!');
            return;
        }
        
        if (!userData.studyProgress) {
            userData.studyProgress = {
                daily: 0,
                weekly: [0, 0, 0, 0, 0, 0, 0],
                subjects: [],
                dailyGoal: 120,
                weeklyGoal: 840
            };
        }
        
        if (!userData.studyProgress.subjects) {
            userData.studyProgress.subjects = [];
        }
        
        // Check if subject already exists
        const exists = userData.studyProgress.subjects.some(s => s.name.toLowerCase() === subjectName.toLowerCase());
        if (exists) {
            alert('Esta disciplina já existe!');
            return;
        }
        
        userData.studyProgress.subjects.push({
            name: subjectName,
            time: 0,
            goal: 180 // Default goal: 3 hours
        });
        
        saveData(); // SALVA DIRETAMENTE
        updateSubjectsProgress();
        document.getElementById('new-subject').value = '';
    }
    
    function deleteSubject(index) {
        if (confirm('Tem certeza que deseja excluir esta disciplina?')) {
            userData.studyProgress.subjects.splice(index, 1);
            saveData(); // SALVA DIRETAMENTE
            updateSubjectsProgress();
        }
    }
    
    function deleteAllSubjects() {
        if (confirm('Tem certeza que deseja apagar TODAS as disciplinas?')) {
            userData.studyProgress.subjects = [];
            saveData(); // SALVA DIRETAMENTE
            updateSubjectsProgress();
        }
    }
    
    function addTimeToSubject() {
        const subjectName = document.getElementById('subject-select').value;
        const timeToAdd = parseInt(document.getElementById('subject-time').value);
        
        if (!subjectName) {
            alert('Por favor, selecione uma disciplina!');
            return;
        }
        
        if (!timeToAdd || timeToAdd <= 0) {
            alert('Por favor, insira um valor válido para minutos!');
            return;
        }
        
        addTimeToSelectedSubject(subjectName, timeToAdd);
        document.getElementById('subject-time').value = '';
    }
    
    function addTimeToSelectedSubject(subjectName, minutes) {
        if (!userData.studyProgress) {
            userData.studyProgress = {
                daily: 0,
                weekly: [0, 0, 0, 0, 0, 0, 0],
                subjects: [],
                dailyGoal: 120,
                weeklyGoal: 840
            };
        }
        
        const subject = userData.studyProgress.subjects.find(s => s.name === subjectName);
        
        if (subject) {
            subject.time += minutes;
            
            // Also update daily and weekly progress
            userData.studyProgress.daily += minutes;
            const today = new Date().getDay();
            const arrayDay = today === 0 ? 6 : today - 1;
            userData.studyProgress.weekly[arrayDay] += minutes;
            
            saveData(); // SALVA DIRETAMENTE
            updateSubjectsProgress();
            updateProgressChart();
            updateDashboard();
            updateWeeklyTotal();
            updateGoalsProgress();
            
            alert(`${minutes} minutos adicionados a ${subjectName}!`);
        } else {
            alert('Disciplina não encontrada!');
        }
    }
    
    function updateWeeklyTotal() {
        if (!userData.studyProgress || !userData.studyProgress.weekly) return;
        
        const weeklyTotal = userData.studyProgress.weekly.reduce((a, b) => a + b, 0);
        const weeklyTotalElement = document.getElementById('weekly-total');
        if (weeklyTotalElement) {
            weeklyTotalElement.textContent = weeklyTotal;
        }
    }
    
    function updateGoalsProgress() {
        if (!userData.studyProgress) {
            userData.studyProgress = {
                daily: 0,
                weekly: [0, 0, 0, 0, 0, 0, 0],
                subjects: [],
                dailyGoal: 120,
                weeklyGoal: 840
            };
        }
        
        // Daily goal
        const dailyPercent = Math.min((userData.studyProgress.daily / userData.studyProgress.dailyGoal) * 100, 100);
        const dailyGoalProgress = document.getElementById('daily-goal-progress');
        const dailyGoalText = document.getElementById('daily-goal-text');
        
        if (dailyGoalProgress) dailyGoalProgress.style.width = `${dailyPercent}%`;
        if (dailyGoalText) dailyGoalText.textContent = `${userData.studyProgress.daily}/${userData.studyProgress.dailyGoal} minutos`;
        
        // Weekly goal
        const weeklyTotal = userData.studyProgress.weekly.reduce((a, b) => a + b, 0);
        const weeklyPercent = Math.min((weeklyTotal / userData.studyProgress.weeklyGoal) * 100, 100);
        const weeklyGoalProgress = document.getElementById('weekly-goal-progress');
        const weeklyGoalText = document.getElementById('weekly-goal-text');
        
        if (weeklyGoalProgress) weeklyGoalProgress.style.width = `${weeklyPercent}%`;
        if (weeklyGoalText) weeklyGoalText.textContent = `${weeklyTotal}/${userData.studyProgress.weeklyGoal} minutos`;
        
        // Days to exam
        const examDate = new Date();
        examDate.setDate(examDate.getDate() + 15);
        const today = new Date();
        const diffTime = examDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const daysToExam = document.getElementById('days-to-exam');
        if (daysToExam) daysToExam.textContent = diffDays;
    }
    
    function updateDailyGoal() {
        const newGoal = parseInt(document.getElementById('daily-goal-input').value);
        
        if (newGoal && newGoal > 0) {
            if (!userData.studyProgress) {
                userData.studyProgress = {
                    daily: 0,
                    weekly: [0, 0, 0, 0, 0, 0, 0],
                    subjects: [],
                    dailyGoal: 120,
                    weeklyGoal: 840
                };
            }
            
            userData.studyProgress.dailyGoal = newGoal;
            saveData(); // SALVA DIRETAMENTE
            updateGoalsProgress();
            alert(`Meta diária atualizada para ${newGoal} minutos por dia!`);
        } else {
            alert('Por favor, insira uma meta válida (maior que 0).');
        }
    }
    
    function updateWeeklyGoal() {
        const newGoal = parseInt(document.getElementById('weekly-goal-input').value);
        
        if (newGoal && newGoal > 0) {
            if (!userData.studyProgress) {
                userData.studyProgress = {
                    daily: 0,
                    weekly: [0, 0, 0, 0, 0, 0, 0],
                    subjects: [],
                    dailyGoal: 120,
                    weeklyGoal: 840
                };
            }
            
            userData.studyProgress.weeklyGoal = newGoal;
            saveData(); // SALVA DIRETAMENTE
            updateGoalsProgress();
            alert(`Meta semanal atualizada para ${newGoal} minutos por semana!`);
        } else {
            alert('Por favor, insira uma meta válida (maior que 0).');
        }
    }
    
    function resetWeeklyProgress() {
        if (confirm('Tem certeza que deseja reiniciar o progresso semanal?')) {
            if (!userData.studyProgress) {
                userData.studyProgress = {
                    daily: 0,
                    weekly: [0, 0, 0, 0, 0, 0, 0],
                    subjects: [],
                    dailyGoal: 120,
                    weeklyGoal: 840
                };
            }
            
            userData.studyProgress.weekly = [0, 0, 0, 0, 0, 0, 0];
            saveData(); // SALVA DIRETAMENTE
            updateProgressChart();
            updateWeeklyTotal();
            updateGoalsProgress();
        }
    }
    
    function resetStudyProgress() {
        if (confirm('Tem certeza que deseja reiniciar TODO o progresso de estudos?')) {
            if (!userData.studyProgress) {
                userData.studyProgress = {
                    daily: 0,
                    weekly: [0, 0, 0, 0, 0, 0, 0],
                    subjects: [],
                    dailyGoal: 120,
                    weeklyGoal: 840
                };
            }
            
            userData.studyProgress.daily = 0;
            userData.studyProgress.weekly = [0, 0, 0, 0, 0, 0, 0];
            userData.studySessions = 0;
            userData.sessionsHistory = [];
            
            // Reset subject times but keep subjects
            if (userData.studyProgress.subjects) {
                userData.studyProgress.subjects.forEach(subject => {
                    subject.time = 0;
                });
            }
            
            saveData(); // SALVA DIRETAMENTE
            updateStudySessions();
            updateDashboard();
            updateProgressChart();
            updateSubjectsProgress();
            updateSessionsHistory();
            updateWeeklyTotal();
            updateGoalsProgress();
        }
    }

    </script>
</body>
</html>

